import time
import visa

rm = visa.ResourceManager()

gen = rm.open_resource('TCPIP0::169.254.2.20::hislip0::INSTR')
sa = rm.open_resource('TCPIP0::169.254.56.102::hislip0::INSTR')
src = rm.open_resource('USB0::0x0AAD::0x0135::039964506::0::INSTR')

"""
source - set params - APPLY 3.3v,50ma,1
source - measure current - MEAS:CURR?
source - turn on output - OUTP:CHAN1 ON 
                          OUTP:MAST ON

gen - turn on output - OUTP ON
gen - set freq - SOURce1:FREQuency:CW 100mhz
gen - set power - :POW:POW 0.1dbm

sa - set start freq - frequency:start 20mhz
sa - set stop freq - frequency:stop 20ghz
sa - turn on marker - calc1:mark1 on 
sa - turn on marker - calc1:mark1:x 200mhz
sa - display reference - level DISP:TRAC1:Y:RLEV -5dbm
sa - switch to phase noise - INST:SEL PNOISE
ss - auto adjust - ADJust:ALL

pna - get trace date - TRAC?
"""


def measure_4pow():
    src.write('APPLY 3.3v,50ma,1')
    src.write('OUTP:CHAN1 ON')
    src.write('OUTP:MAST ON')

    # sa.write(f'DISP:TRAC1:Y:RLEV -5dbm')
    sa.write(f'BAMD 200khz')

    result = []

    fs = [f / 10 for f in range(1, 65)]

    for f in fs:
        print('set freq', f)

        gen.write(f'SOUR:FREQ:CW {f}ghz')
        gen.write(':POW:POW 13.0dbm')
        gen.write('OUTP ON')

        time.sleep(0.5)

        sa.write('frequency:start 20mhz')
        sa.write('frequency:stop 30ghz')
        sa.write('CALC1:MARK1 ON')
        sa.write(f'CALC1:MARK1:X {f}ghz')
        sa.write('CALC1:MARK2 ON')
        sa.write(f'CALC1:MARK2:X {f * 2}ghz')
        sa.write('CALC1:MARK3 ON')
        sa.write(f'CALC1:MARK3:X {f * 3}ghz')
        sa.write('CALC1:MARK4 ON')
        sa.write(f'CALC1:MARK4:X {f * 4}ghz')

        time.sleep(0.5)

        pw1 = sa.query(f'CALC1:MARK1:Y?')
        pw2 = sa.query(f'CALC1:MARK1:Y?')
        pw3 = sa.query(f'CALC1:MARK1:Y?')
        pw4 = sa.query(f'CALC1:MARK1:Y?')

        print('read power', pw1, pw2, pw3, pw4)

        result.append([float(pw1), float(pw2), float(pw3), float(pw4)])

    print('stats', result)

    """
    [[-39.2609176636, -39.2609176636, -39.2609176636, -39.2609176636], [-33.9104003906, -33.9104003906, -33.9104003906, -33.9104003906], [-30.6345844269, -30.6345844269, -30.6345844269, -30.6345844269], [-29.1845207214, -29.1845207214, -29.1845207214, -29.1845207214], [-27.7111377716, -27.7111377716, -27.7111377716, -27.7111377716], [-27.0633087158, -27.0633087158, -27.0633087158, -27.0633087158], [-27.5870819092, -27.5870819092, -27.5870819092, -27.5870819092], [-28.7566127777, -28.7566127777, -28.7566127777, -28.7566127777], [-31.129360199, -31.129360199, -31.129360199, -31.129360199], [-35.1684913635, -35.1684913635, -35.1684913635, -35.1684913635], [-39.1729125977, -39.1729125977, -39.1729125977, -39.1729125977], [-31.8861312866, -31.8861312866, -31.8861312866, -31.8861312866], [-26.1037158966, -26.1037158966, -26.1037158966, -26.0573196411], [-20.7930107117, -20.7930107117, -20.7930107117, -20.7930107117], [-18.8513355255, -18.8513355255, -18.8513355255, -18.8513355255], [-26.6544265747, -26.6544265747, -26.6544265747, -26.6544265747], [-35.5790367126, -35.5790367126, -35.5790367126, -35.5790367126], [-25.2219276428, -25.2219276428, -25.2219276428, -25.2219276428], [-20.6443729401, -20.6443729401, -20.6255931854, -20.6255931854], [-17.9016208649, -17.9016208649, -17.9016208649, -17.9016208649], [-17.1173667908, -17.1173667908, -17.1173667908, -17.1173667908], [-15.6374664307, -15.6374664307, -15.6374664307, -15.6374664307], [-10.7406625748, -10.7406625748, -10.7406625748, -10.7406625748], [-4.61289691925, -4.61289691925, -4.61289691925, -4.61289691925], [-0.91180980206, -0.91180980206, -0.91180980206, -0.91180980206], [2.16072392464, 2.16072392464, 2.16072392464, 2.16072392464], [3.12816047668, 3.12816047668, 3.12816047668, 3.12816047668], [2.08715438843, 2.08715438843, 2.08715438843, 2.08715438843], [1.10003316402, 1.10003316402, 1.10003316402, 1.10003316402], [-1.12040042877, -1.12040042877, -1.12040042877, -1.12040042877], [-2.99806284904, -2.99806284904, -2.99806284904, -2.99806284904], [-3.99301242828, -3.99301242828, -3.99301242828, -3.99301242828], [-5.13312768936, -5.13312768936, -5.13312768936, -5.13312768936], [-6.25356292725, -6.25356292725, -6.25356292725, -6.25356292725], [-7.25220727921, -7.25220727921, -7.25220727921, -7.25220727921], [-7.6917386055, -7.6917386055, -7.6917386055, -7.6917386055], [-8.40679550171, -8.4012670517, -8.4012670517, -8.4012670517], [-9.24632072449, -9.24632072449, -9.24632072449, -9.24632072449], [-11.3458337784, -11.3458337784, -11.3458337784, -11.3458337784], [-11.811378479, -11.811378479, -11.811378479, -11.811378479], [-11.5668287277, -11.5668287277, -11.5668287277, -11.5668287277], [-10.0586910248, -10.0586910248, -10.0586910248, -10.0684452057], [-11.242061615, -11.242061615, -11.242061615, -11.242061615], [-14.3506975174, -14.3506975174, -14.3506975174, -14.3506975174], [-15.8907756805, -15.8907756805, -15.8907756805, -15.8907756805], [-18.9149436951, -18.9149436951, -18.9149436951, -18.9149436951], [-26.2943553925, -26.2943553925, -26.2943553925, -26.2943553925], [-23.6926879883, -23.6926879883, -23.6926879883, -23.6926879883], [-14.6606140137, -14.6493968964, -14.6493968964, -14.6493968964], [-9.89631175995, -9.89631175995, -9.89631175995, -9.89631175995], [-6.88228178024, -6.88228178024, -6.88228178024, -6.88228178024], [-4.36429166794, -4.36429166794, -4.36429166794, -4.36429166794], [-2.94880723953, -2.94880723953, -2.94880723953, -2.94880723953], [-2.33261990547, -2.33261990547, -2.33261990547, -2.33261990547], [-2.69220685959, -2.69220685959, -2.69220685959, -2.69220685959], [-1.97064888477, -1.97064888477, -1.97064888477, -1.97064888477], [-1.95424842834, -1.95424842834, -1.95424842834, -1.95424842834], [-3.05070972443, -3.05070972443, -3.05070972443, -3.05070972443], [-2.68704509735, -2.68704509735, -2.68704509735, -2.68704509735], [-2.91868805885, -2.91868805885, -2.91868805885, -2.91868805885], [-2.58246541023, -2.58246541023, -2.58246541023, -2.58246541023], [-2.75972676277, -2.75972676277, -2.75972676277, -2.75972676277], [-3.1577334404, -3.1577334404, -3.1577334404, -3.1577334404], [-3.42430114746, -3.42430114746, -3.42430114746, -3.42430114746]]
    """

